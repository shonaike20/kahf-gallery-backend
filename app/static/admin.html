<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KAHF ADMIN</title>

  <style>
    :root {
      --bg: #f4efe9;
      --card: #ffffff;
      --text: #2f2f2f;
      --muted: #7a7a7a;
      --accent: #b89b7c;
      --border: #e2d9cf;
    }

    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      display: flex;
      justify-content: center;
      padding: 40px 0;
    }

    .container {
      width: 100%;
      max-width: 1000px;
      background: var(--card);
      padding: 28px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.06);
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
    }

    .logo {
      width: 72px;
      height: 72px;
      margin: 0 auto 12px;
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    h1 {
      margin: 0;
      letter-spacing: 2px;
      font-size: 22px;
    }

    .subtitle {
      font-size: 13px;
      color: var(--muted);
    }

    .mode-buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 16px;
    }

    button {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
    }

    button.secondary {
      background: #d6c5b1;
    }

    button:hover {
      opacity: 0.9;
    }

    /* ---------- UPLOAD ---------- */

    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }

    input, textarea {
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    #status {
      margin-top: 12px;
      font-size: 13px;
      color: var(--muted);
      text-align: center;
    }

    /* ---------- PREVIEW ---------- */

    .preview-box {
      width: 100%;
      height: 380px;               /* ðŸ”’ LOCKED HEIGHT */
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      background: #faf7f3;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .preview-box img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 6px;
    }

    .preview-placeholder {
      color: var(--muted);
      font-size: 13px;
    }

    /* ---------- TABLE ---------- */

    .table-container {
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: 20px;
      overflow: hidden;
    }

    .table-header,
    .table-row {
      display: grid;
      grid-template-columns: 50px 1.2fr 1fr 1fr 1.6fr 120px;
      align-items: center;
      padding: 8px 10px;
      gap: 8px;
    }

    .table-header {
      background: #faf7f3;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }

    .table-row {
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      cursor: pointer;
    }

    .table-row:last-child {
      border-bottom: none;
    }

    .table-row input {
      width: 100%;
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .thumb {
      width: 28px;
      height: 28px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    .row-actions {
      display: flex;
      gap: 6px;
    }

    .row-actions button {
      font-size: 11px;
      padding: 6px 8px;
    }

    /* ---------- PAGINATION ---------- */

    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 14px;
      font-size: 13px;
      color: var(--muted);
    }
  </style>
</head>

<body>
<div class="container">

  <div class="header">
    <div class="logo">
      <img src="/static/kahf-logo.png" alt="KAHF Logo">
    </div>
    <h1>KAHF ADMIN</h1>
    <div class="subtitle">Gallery admin console</div>

    <div class="mode-buttons">
      <button class="secondary" id="uploadBtn">Upload</button>
      <button class="secondary" id="viewBtn">View Images</button>
    </div>
  </div>

  <!-- UPLOAD SECTION -->
  <div id="uploadSection">
    <label style="display:flex;align-items:center;gap:8px;">
      <input type="checkbox" id="bulkToggle">
      <strong>Bulk Upload Mode</strong>
    </label>

    <form id="uploadForm">
      <input type="file" id="imageInput" required>

      <input type="text" id="baseName" placeholder="Base name (optional)" style="display:none">

      <small id="baseHint" style="display:none;color:#7a7a7a;">
        If empty, base name is derived from author + series + date.
      </small>

      <input type="text" id="imageNameInput" placeholder="Image name">
      <input type="text" name="series_name" placeholder="Series (optional)">
      <input type="text" name="author" placeholder="Author (optional)">
      <textarea name="description" placeholder="Description (optional)"></textarea>

      <button type="submit">Upload</button>
    </form>

    <p id="status"></p>
  </div>

  <!-- VIEW SECTION -->
  <div id="viewSection" style="display:none;">

    <div class="preview-box">
      <span id="previewPlaceholder" class="preview-placeholder">
        Hover over a row to preview image
      </span>
      <img id="previewImage" src="" style="display:none">
    </div>

    <div class="table-container">
      <div class="table-header">
        <div>Img</div>
        <div>Name</div>
        <div>Series</div>
        <div>Author</div>
        <div>Description</div>
        <div>Actions</div>
      </div>
      <div id="tableBody"></div>
    </div>

    <div class="pagination">
      <button id="prevBtn">Prev</button>
      <span id="pageInfo"></span>
      <button id="nextBtn">Next</button>
    </div>
  </div>

</div>

<script>
  const PAGE_SIZE = 20;
  let images = [];
  let page = 0;

  const uploadSection = document.getElementById("uploadSection");
  const viewSection = document.getElementById("viewSection");
  const uploadBtn = document.getElementById("uploadBtn");
  const viewBtn = document.getElementById("viewBtn");

  uploadBtn.onclick = () => {
    uploadSection.style.display = "block";
    viewSection.style.display = "none";
  };

  viewBtn.onclick = () => {
    uploadSection.style.display = "none";
    viewSection.style.display = "block";
    loadImages();
  };

  // BULK TOGGLE
  const bulkToggle = document.getElementById("bulkToggle");
  const imageInput = document.getElementById("imageInput");
  const imageNameInput = document.getElementById("imageNameInput");
  const baseNameInput = document.getElementById("baseName");
  const baseHint = document.getElementById("baseHint");
  const statusEl = document.getElementById("status");

  bulkToggle.onchange = () => {
    if (bulkToggle.checked) {
      imageInput.multiple = true;
      imageNameInput.disabled = true;
      baseNameInput.style.display = "block";
      baseHint.style.display = "block";
    } else {
      imageInput.multiple = false;
      imageNameInput.disabled = false;
      baseNameInput.style.display = "none";
      baseHint.style.display = "none";
    }
  };

  // UPLOAD
  document.getElementById("uploadForm").onsubmit = async (e) => {
    e.preventDefault();
    const isBulk = bulkToggle.checked;
    const fd = new FormData();

    if (isBulk) {
      for (const f of imageInput.files) fd.append("images", f);
      if (baseNameInput.value.trim()) fd.append("base_name", baseNameInput.value.trim());
    } else {
      fd.append("image", imageInput.files[0]);
      fd.append("image_name", imageNameInput.value.trim());
    }

    ["series_name", "author", "description"].forEach(n => {
      const el = e.target.querySelector(`[name="${n}"]`);
      if (el && el.value.trim()) fd.append(n, el.value.trim());
    });

    const endpoint = isBulk ? "/api/images/bulk" : "/api/images";
    statusEl.innerText = "Uploading...";

    const res = await fetch(endpoint, { method: "POST", body: fd });
    const json = await res.json();

    statusEl.innerText = res.ok
      ? (isBulk ? `Uploaded ${json.count} images` : `Uploaded image ID ${json.id}`)
      : (json.detail || "Upload failed");

    e.target.reset();
    bulkToggle.onchange();
  };

  // TABLE VIEW
  async function loadImages() {
    const res = await fetch("/api/images");
    images = await res.json();
    page = 0;
    renderPage();
  }

  function renderPage() {
    const body = document.getElementById("tableBody");
    const previewImage = document.getElementById("previewImage");
    const previewPlaceholder = document.getElementById("previewPlaceholder");

    body.innerHTML = "";
    previewImage.style.display = "none";
    previewPlaceholder.style.display = "block";

    images.slice(page * PAGE_SIZE, (page + 1) * PAGE_SIZE).forEach(img => {
      const row = document.createElement("div");
      row.className = "table-row";

      row.innerHTML = `
        <img class="thumb" src="/api/images/${img.id}/data">
        <input value="${img.image_name || ""}" data-field="image_name">
        <input value="${img.series_name || ""}" data-field="series_name">
        <input value="${img.author || ""}" data-field="author">
        <input value="${img.description || ""}" data-field="description">
        <div class="row-actions">
          <button data-save>Save</button>
          <button data-delete>Delete</button>
        </div>
      `;

      row.onmouseenter = () => {
        previewImage.src = `/api/images/${img.id}/data`;
        previewImage.style.display = "block";
        previewPlaceholder.style.display = "none";
      };

      row.querySelector("[data-save]").onclick = async (e) => {
        e.stopPropagation();
        const fd = new FormData();
        row.querySelectorAll("input").forEach(i => fd.append(i.dataset.field, i.value));
        await fetch(`/api/images/${img.id}`, { method: "PUT", body: fd });
      };

      row.querySelector("[data-delete]").onclick = async (e) => {
        e.stopPropagation();
        if (!confirm("Delete image?")) return;
        await fetch(`/api/images/${img.id}`, { method: "DELETE" });
        images = images.filter(i => i.id !== img.id);
        renderPage();
      };

      body.appendChild(row);
    });

    document.getElementById("pageInfo").innerText =
      `Page ${page + 1} of ${Math.max(Math.ceil(images.length / PAGE_SIZE), 1)}`;
  }

  document.getElementById("prevBtn").onclick = () => {
    if (page > 0) { page--; renderPage(); }
  };

  document.getElementById("nextBtn").onclick = () => {
    if ((page + 1) * PAGE_SIZE < images.length) {
      page++;
      renderPage();
    }
  };
</script>

</body>
</html>
